# 「JOISC 2022 Day3」蚂蚁与方糖

首先答案就是将所有蚂蚁的位置建点，所有糖的位置建点，然后一个蚂蚁代表的点向可以得到的糖的点连边，这样得到的二分图的最大匹配就是答案

那么显然直接跑是不行的，那么可以考虑用Hall定理求出最大匹配，相当于我们要选出一个蚂蚁所在位置的集合$S$，记$N(S)$表示$S$中可以到达方糖位置的集合，然后需要最大化$\max(|S|-|N(S)|)$，可以再进行转化变成最大化$|S|+|T|-$方糖的个数和，其中$T$表示$S$中位置不能到达方糖的位置集合

我们可以给所有蚂蚁的坐标加上$L$，然后强制蚂蚁只能向负轴方向走$2L$的长度

那么相当于在值域上划分成若干个0/1区间交替，其中0区间表示选择蚂蚁位置的区间，假设这个区间为$[l,r]$，那么区间$[l+2L,r]$所有蚂蚁都要被选择，然后1区间看作没有被选择蚂蚁到达的区间，区间内所有方糖都要选择

那么记区间的右端点序列为$p_1,p_2,..,p_k$，然后记$A_i$表示蚂蚁的前缀和，$B_i$表示方糖个数的前缀和

那么得到的价值就是$A_{p_1}+B_{p_2}-B_{p_1}+A_{p_3}-A_{p_2+2L}...$然后可以整理分成两类

$B_x-A_{x+2L}$和$A_x-B_x$，并且这两类交替出现，如果最后一个出现的是$B_x-A_{x+2L}$那么还需要加上$B_{inf}$如果是$A_x-B_x$则还需要加上$A_{inf}$

那么就可以考虑用线段树维护选择的价值，可以设$f(x,0/1,0/1)$表示当前线段树区间中开头选择的是哪一种以及结尾选择的是哪一种的最佳方案数

但是这样做是忽略了一个限制就是选择蚂蚁的区间长度必须要$\geq 2L$，但是注意到如果选择的方案中存在长度$<2L$的蚂蚁区间的话，那么一定是不优的，最终最优方案中一定是合法的

然后每一次修改相当于对$A,B$进行后缀加法，假设修改的位置是$x$，个数为$v$

- 如果需要修改的是$B$，那么只需要根据$f(x,0/1,0/1)$取值判断是否需要修正，要么+v，要么-v，中间的修改都抵消掉，最多留下一个修改量
- 如果需要修改的是$A$，就比较麻烦，首先需要对$\geq x$的位置进行修改，修改方式跟修改$B$的方式类似，只需要进行一次修改就行中间所有的修改量都抵消，但是注意到第一种选择的时候$B_x-A_{x+2L}$有$x+2L$的下标，那么说明还需要对$[x-2L,x)$的区间进行修改，但是此时修改的时候需要记录选择$B_x-A_{x+2L}$才能进行修改，注意到如果选择了这个选择，那么在$[x-2L,x)$中只会选择一次，那么在线段树中再记录大小为2的维度即可

如果进行离散化，那么这样的时间复杂度就是$O(q\log q )$

