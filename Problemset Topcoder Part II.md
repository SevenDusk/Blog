# SRM 489 1000pts AppleTrees

 一个出现了第二次的技巧

首先可以发现，我们只关心所种树的相对位置，考虑将一个排列放到D个格子上有几种方案

考虑将两个树之间的空隙看作$n+1$​个盒子，将空格看作球放入盒子中，并且中间的$n-1$个盒子有放球的下限$\max (r_{p_{i}},r_{p_{i+1}})$

我们有
$$
M=\sum\limits_{i=1}^{n-1} \max (r_{p_{i}},r_{p_{i+1}})\\
M\leq D
$$
空格数量为$D-n$，方案数为$\binom{D-M}{n}$

那么只需要统计$M=k$的排列数量有多少个

考虑按$r$从小到大插入元素，一个r能贡献的次数就是在其插入的时候，两边存在元素的个数，那么我们只需要关系当前联通块个数，维护他们的相对关系

设$dp(i,j,k)$表示考虑到前$i$小的$r$，当前联通块有$j$个，$M=k$
$$
dp(i,j,k)=2j*dp(i-1,j,k-r_i+1)+j*dp(i-1,j+1,k-2r_i+2)+j*dp(i-1,j-1,k)
$$

# SRM 419 1000pts CactusAutomorphisms

## 题目大意

给定一个点仙人掌（一个点最多只在一个简单环中），求出与其同构的仙人掌数量，这里的同构就是一个排列$p$，要求原图中$i,j$存在边那么$p_i,p_j$也一定要存在
$$
n\leq 200
$$

## 算法讨论

首先可以对点仙人掌进行边双缩点，可以发现的是这个每一个边双节点都是一个环，并且不存在其他边

答案的贡献是由两部分得来的

第一部分是对于一个环来说，可以进行翻转，旋转操作

第二部分是对于两个子仙人掌的位置可以互换，也就是在缩成的树上，某一个节点的同构儿子子树可以互换，**或者一条边的两个子树同构**

显然每一个部分内的贡献都是独立的，那么答案只需要将所有的贡献乘起来即可

首先考虑如何计算第一部分的贡献

先考虑旋转，假设一开始的环编号为$1,2,...,k$，那么旋转相当于将这个编号序列进行循环移位，那么合法的排列有$k$个，再考虑翻转，那么得到的编号序列为$k,k-1,...,1$，然后还可以进行循环移位，那么也有$k$个排列合法，总共合法排列为$2k$

这个只是考虑单单一个环的情况，我们还需要考虑这个环上挂着的子仙人掌，假设$i$通过排列变换到$j$，那么$i$的子仙人掌要与$j$的子仙人掌同构，否则该排列不合法

那么我们可以对这$2k$个排列都进行检查，将合法排列数量乘到贡献中

剩下的问题就是如何解决判仙人掌同构的问题，首先如果退化成树是简单的，我们可以定义一个节点的Hash函数$h_x$，记$pr_k$表示第$k$个子树
$$
h_x=1+\sum\limits_{u\in son(x)}h_u\times pr_{sz_u}
$$
考虑扩展到仙人掌上，考虑一个环$p_0,p_1,...,p_{k-1}$，**首先我们知道枚举到这个环时候是从哪个节点进入的**，显然不能再返回去，然后我们按照一个确定的顺序枚举这个环上的节点，得到以枚举节点为根时候子仙人掌的Hash值，由于环可以旋转同构，那么Hash函数必须只与相对顺序有关，并且还可以翻转同构，那么说明要与遍历环的顺序无关

考虑将环上Hash值相同并且连续的缩成一段，hash值记作$f_i$，个数为$cnt_i$，总共有$k'$段
$$
\prod\limits_{i=0}^{k'-1} (z^{cnt_{i+1}}f_{i+1}-z^{cnt_i}f_i)
$$
**这个hash函数是满足旋转同构的，翻转同构，正着枚举和反着枚举是可能为相反数的，那么处理比较节点求上式的平方即可，需要注意的是，由于环是从某个节点进入的，计算Hash值是没有考虑这个的，那么需要给$f_x$乘一个度数**

那么解决同构的问题了

然后考虑第二部分的贡献，就直接枚举点/边，看子树的同构等价类，假设一个等价类大小为$k$，其贡献为$k!$，**注意在枚举点的时候，不能将环上其他点考虑进去**

为了方便实现，时间复杂度写了$O(n^2)$，但事实上实现精细可以简单优化到$O(n)$

# TCO13 2C Round 1000pts

