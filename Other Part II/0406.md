# A.必要之恶 「USACO 2020 US Open Platinum」Circus

首先考虑强制钦定这$k$个点可能所在的位置集合，规定在只能在这些位置上存在点

那么我们只需要求出只有这$k$个位置有点的时候等价类数 量，那么可以注意到最小的操作单位其实上是一对点，就是交换这两个点上的编号不会影响到其他点位置上的编号

可以发现的是如果我们可以交换$(a,b),(b,c)$，那么一定可以交换$(a,c)$，那么这些二元关系最终一定是形成若干个完全图

假设这些完全图联通块的大小为$s_i$，那么最终的方案数为$\frac{k!}{\prod s_i!}$

接下来就是如何求出各个$s_i$

首先需要确定这$k$个点在哪些位置上，一种做法是选定一个节点为根，然后所有节点按照深度从大到小依次当作可以放置的节点

这样的话对于任意的$k$来说，图中可以放置的节点一定是若干个不交的子树并集，接下来考虑如何判断两个点$x,y$之间可以进行交换

首先假设当前可以放置的节点称为黑点，不能放置的节点称为白点

考虑这个交换的过程，实际上是将我们需要进行交换的节点移动到特定的位置，并且在此处进行交换不影响其他节点。对于其他节点来说其位置可能会发生改变，但是在交换完我们需要交换节点之后，可以通过原路返回到初始的位置

如果能进行交换，$x,y$需要被移动到一个路径产生分叉的位置上

- 首先$x,y$如果在同一个子树内

  - 如果$x,y$为祖先关系，首先可以考虑$x$为$y$的直接父亲的情况，需要注意的是此时白点可以任意放置到任意节点上，那么只需要创造出一个分叉即可，那么也就是说在$x$的子树外找到一个最近的节点满足节点的度数$\geq 3$，假设距离为$d$，那么此时需要的白点数量等于$d+2$，那么此时的$k\leq n-d-2$

    接下来考虑不是直接父亲的关系，但是这种情况是不需要进行考虑的，考虑$x$到$y$链上节点的顺序，假设$x$直接相邻在链上的节点为$z$，那么如果$x,y$可以进行交换，那么$x,z$也一定可以进行交换，依次类推，那么该链上所有节点都可以进行交换，那么也就是说链上任意两个相邻的节点都是可以进行交换的，只考虑上面这种情况就可以将这条链连成一个联通块了

  - 如果$x,y$不为祖先关系，由于$x,y$在同一个子树内，那么其$LCA$的位置也一定是黑点，那么根据上面的推理过程，可以尝试缩减需要检查是否可以交换的对数。可以考虑固定$x$，那么对于一个在$y$到$LCA$路径上的节点$z$，如果$(x,y)$之间可以相互交换，那么由于$z$节点比$y$节点更浅，也就更容易进行交换

    那么这样的话，我们就只需要考虑$x,y$直接和$LCA$相邻的情况，此时由于已经存在一个分叉，那么只需要存在两个白点即可，也就是$k\leq n-2$，但是注意到需要将一个节点的所有儿子节点连在一起，那么可以建立一个虚点，每一次将儿子节点连向这个虚点即可

- 如果$x,y$不在同一个子树内，通过类似的推理过程可以发现，只需要考虑$x,y$分别为两个不相交极大黑色子树的根即可，注意到如果我们以某一个叶子节点作为根的话，只要$k<n$那么一定可以将$x,y$进行交换

那么我们可以得到每一条边在哪一个时间之内是有效的，那么可以考虑$k$从$n-1$开始枚举，那么我们需要支持的操作就是加边和删除某一个节点，那么求出每一个联通块中点数阶乘的乘积即可

需要注意的是随着白点数量的增加，$(x,y)$不可能从可以进行交换变成不能进行交换，那么删除节点就不会影响联通性，那么可以直接修改所在联通块的大小即可

由于加入的边只有$O(n)$条，那么总时间复杂度$O(n\alpha(n))$