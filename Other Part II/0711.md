# A.地铁/「JOISC 2017 Day 2」门票安排

由于我们需要最小化所有的道路经过次数最大值，那么我们需要让所有人覆盖的道路分配尽量均匀，那么如果$c_i$为偶数，那么我们令$\frac{c_i}{2}$的人逆时针走令另外的$\frac{c_i}{2}$顺时针走，那么这样我们只需要将$c_i$变成0，然后将最终答案加上$\frac{c_i}{2}$。如果$c_i$为奇数，那么两个方向走过的人数相差1，将$c_i$变成1，然后最终答案加上$\frac{c_i-1}{2}$即可

那么我们现在只需要考虑$c_i=1$的情况，首先考虑将环写成序列的形式

那么一个人对应着的区间应该是$A_i\leq B_i,[A_i,B_i]$或者$[1,A_i-1]\cup [B_i+1,n]$

可以考虑二分答案，现在需要判定是否存在对于每一个人选择区间的方案，使得每一个元素被区间覆盖的次数$\leq mid$

我们可以强制钦定一开始区间都是选择$[A_i,B_i]$，相当于给区间中的所有元素+1

那么现在变成选择其中一些人将其选择的区间变换，选择一个人造成的影响就是先将全部元素+1，然后将区间$[A_i,B_i]$中的元素-2

注意到如果我们确定需要修改多少个人选择的区间，那么问题就变成了要选出k个区间，然后将区间内的数-2，问最终是否可能将每一个位置上的数$\leq mid$

这个问题可以通过贪心解决，从左到右考虑所有位置，如果当前位置的数$>mid$，那么找到覆盖这个位置并且没有被选过的区间中右端点最大的那个，那么可以通过一个堆来维护

如果我们枚举所有的$k$的话，复杂度是$O(n^2\log^2 n)$的

那么需要分析一些性质，首先如果选择了两个不交的区间，一定是不优的，选择两个不交区间的影响叠加起来一定比之前的更劣

那么说明我们选择的区间一定有交，并且可以发现的是每一个位置减少的数量是以相交部分为中心向左右两边递减的

接下来考虑从一个合法方案出发，通过删除一些不会影响答案的区间，缩小需要检查的范围

那么注意到如果在选择区间之前的最大值不在相交的范围内，那么说明相交范围内减少的数量至少比最大值位置减少的大$2$，那么我们可以同时删除两个区间来调整方案，这两个区间分别为左端点为相交范围左端点的区间和右端点为相交范围右端点的区间，最终方案一定是相交范围包含最大值的位置

既然相交范围包含最大值，那么也可以不断减小，直到k=max-mid或者k=max-mid+1

# C.圈

首先注意到如果对$a_i$进行操作，那么左右两边的数会变成 $a_{i-1}-a_i,-a_i,a_{i+1}-a_i$，发现我们并不好对这个操作对序列的影响具体刻画

那么可以考虑$a$的前缀和$s$，那么如果我们对$i\in (1,n)$的位置进行操作的话，那么可以发现是交换$s_{i-1},s_{i}$，并且我们最终要求前缀和序列是单调不降的

但是注意到如果我们对$i=1,i=n$进行操作，由于这个结构是环形，那么操作对单纯前缀和的影响是很复杂的

那么这里可以考虑定义一个广义前缀和，用于处理环上的前缀和，我们令$s$序列是一个无限的序列，令$s_i=s_{i-1}+a_{i \bmod n}$，其中$a_0=a_n$

我们强制令$s_0=0$，那么如果原序列$a$合法，那么$s$整个序列就是单调不降的，整个条件又等价于这个序列的$1$到$n$项单调不降

可以发现的是上述转换需要$a$序列的之和$>0$，如果$a$序列的之和$\leq 0$如果不是a序列全0，否则都是无解

那么如果我们对$i$进行操作，那么相当于交换$s_{i+kn}$和$s_{i-1+kn}$

由于需要排序，那么可以考虑逆序对数量的变化，如果记$R_i=\sum\limits_{j>i} [s_j<s_i]$，在交换的时候也需要交换$R_{i+kn},R_{i-1+kn}$

- 如果$s_{i+kn}>s_{i-1+kn}$，那么R交换后，$R_{i-1+kn}+1$
- 如果$s_{i+kn}<s_{i-1+kn}$，那么R交换后，$R_{i+kn}-1$

显然如果序列还没有排好序，那么一定存在一个$i\in [1,n]$满足$s_{i}<s_{i-1}$，那么进行一次操作就可以使$\sum\limits_{i=1}^n R_i$减少1

那么需要的最少操作数就是$\sum \limits_{i=1}^nR_i$

如果记$d=\sum a_i$，那么$R_i=\sum\limits_{j\in[1,n]}[s_j<s_i]\lfloor\frac{s_i-s_j-1}{d}\rfloor+\sum\limits_{j=i+1}^n [s_j<s_i]$

后面那一项等价于统计$s_{1...n}$的逆序对数量，主要考虑前面的计算

那么首先可以将$s$按照大小排序，然后从前往后统计

由于$\lfloor\frac{s_i-s_j-1}{d}\rfloor=\lfloor\frac{s_i-1}{d}\rfloor-\lfloor\frac{s_j}{d}\rfloor-[(s_i-1)\bmod d<s_j\bmod d]$

那么通过离散化+树状数组就可以做到$O(n\log n)$