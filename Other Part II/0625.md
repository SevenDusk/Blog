# A.题目详情 - [[220627]A - HaltOJ](https://haltoj.top/d/haoba/p/215) Boring Problem

这个问题相当于一个给定了初始串的并且给定时模式串集合的无限猴子问题，也许可以通过停时定理或者pgf推导，不会

注意到数据范围比较小，应该是通过高斯消元解期望方程

那么将所有$n$个串建立AC自动机，那么相当于在这个自动机上进行随机游走，如果走到了某一个点的结尾位置那么就停下，求停下的期望步数

注意到所有的串长都是相同的，那么只有在Trie上的叶子节点是合法的终止节点

那么可以设 $f_x$ 表示当前在AC自动机上$x$号节点还需要期望$f_x$步走到终止节点，假设$next(x,i)$表示从$x$节点出发经过$i$的转移边走到的位置，那么可以列出方程
$$
f_x=1+\sum\limits_{i=0}^{k-1} p_i\times f_{next(x,i)}
$$
由于AC自动机上存在$O(nm)$个节点，那么直接解的复杂度就是$O(n^3m^3)$

那么有两种思考方式，第一种就是类似树上高斯消元的做法，注意到$next(x,i)$集合中除了$x$节点在Trie树上的儿子，其他到达的节点深度一定是$\leq $x节点所在的深度，那么尝试将$f_x$表示成$<x$节点的形式，然后就可以在根处解出根的答案，然后依次递推即可

但是会发现$=x$深度的节点很难处理，还需要一个高斯消元才行，那么就需要考虑第二种思路，考虑找出比原问题规模更小的主元，其他的节点用主元表示

如果将所有叶子节点拉出来建一棵虚树，那么虚树上的节点一定都是trie上儿子节点数量$>1$的，那么考虑如何缩掉儿子度数=1的节点

假设一个节点$x$儿子边上的字符为$c$
$$
f_{next(x,c)}=\frac{f_x-1-\sum\limits_{i\in [0,k-1],i\neq c} f_{next(x,i)}}{p_c}
$$
那么可以发现此时我们将所有儿子度数>2的所有儿子作为主元即可表示出其他所有$f_x$，其中根节点也需要作为主元

可以发现的是主元个数只有$O(n)$个，那么直接高斯消元即可复杂度$O(n^3+n^2mk)$