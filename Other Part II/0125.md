# 「2018 集训队互测 Day 1」完美的队列

首先就是求出在某一次操作中插入的数被全部弹出的时间是什么时候，记作$f_i$，那么可以通过扫描线求出每一个时间当前存在多少种颜色，这样的话除了需要求出$f_i$这一次操作以外都是可以视作弹出操作

那么相当于在插入的位置都有一个$a_i$的数，如果之后操作覆盖了这些位置，那么将覆盖的位置上的数-1，直到所有数都$\leq 0$

那么考虑线段树分治，利用线段树将插入的区间拆解成若干块，那么只要求出所有块对应的全部弹出时间，然后将所有块的时间取max就是原来的$f_i$，对于某一个线段树节点，将插入的块按照时间排序，那么可以发现这些块对应的$f_i$一定是单调上升的

那么我们就可以用双指针进行维护，然后需要考虑有哪些操作会对这个节点上的块产生影响，首先是线段树儿子子树内部的操作，这些都是散点操作，并且总个数不会超过$O(\log n)$个（考虑线段树插入一个区间的过程），还有就是祖先的操作，显然祖先的操作都是完全覆盖当前线段树节点代表区间

那么我们可以用另一个线段树维护当前这些位置的最大值，需要支持区间减操作，这样就可以处理儿子操作的影响，然后还需要考虑祖先操作的影响，那么在dfs线段树的过程中，需要用树状数组维护一下关于时间的操作次数前缀和

那么在处理当前节点的时候，就可以用双指针进行维护了

时间复杂度$O(n\log ^2n)$

# 「THUPC 2021 初赛」区间众数

首先考虑一个区间合法条件，就是这个区间中心$mid=\frac{l+r}{2}$，满足$a_{mid}=mid$

那么也就是说对于一种出现的数字，其最多只有可能有一个中心，那么枚举所以可能合法的中心，注意到我们只需要记录区间边界到中心的距离就可以知道整个区间的信息，并且由于我们要求这个中心代表的数是区间众数，那么如果确定这个区间内出现的次数，那么只需要通过判断其他数出现次数是否小于等于这个数的出现次数即可

假设区间边界到中心的距离为$d$，当前中心为$i$，那么$d\in [0,\min(i-1,n-i)]$

那么考虑预处理出区间内出现了$j$个$i$的$d$的范围$[l_j,r_j]$，然后如果在这个区间内其他数出现的最大次数$\leq j$，那么说明这个区间就是合法的

那么显然$d$的范围一定类似$[l_j,pos]$的一个区间

那么考虑根号分治，对于$i$出现次数$>\sqrt n$的，那么我们可以直接通过$O(n)$扫描同时记录每一个数的出现次数，然后求出$pos$，这一部分的时间复杂度为$O(n\sqrt n)$

那么对于$\leq \sqrt n$的个数，那么$j\leq \sqrt n$，那么可以将所有这样的区间按照$j$排序，然后对于一个相同的$j$，可以通过单指针求出$f_i$从位置$i$出发，最远可以到$f_i$，使得$[i,f_i]$中出现次数最多$\leq j$

那么对于一个范围就可以通过二分求出$pos$，这部分的时间复杂度为$O(n\sqrt n+n\log n)$

那么相当于我们现在有若干个合法范围，可以用$(x,l,r)$表示，表示$[x-d,x+d],d\in[l,r]$是合法区间，并且这样的三元组个数为$O(n)$

由于询问要求一个区间内部合法区间的数量，考虑一个中心在区间内情况，那么其$d\leq \min(x-l,r-x)$，根据取哪一个为min，那么可以将询问区间拆成两个

然后将三元组$(x,l,r)$拆成两个新的三元组$(x,y,v)$表示$d\in[0,y]$中的贡献为$v$

那么可以通过离线树状数组求出答案，这部分时间复杂度$O((q+n)\log n)$

总时间复杂度$O(n\sqrt n+(q+n)\log n)$

