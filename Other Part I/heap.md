对于一颗满二叉堆来说，我们需要求出插入一个节点期望比价次数（也就是插入的期望深度）

之后我们假定输入的数据都是一个排列，并且等概率生成

# 定理1

插入到第$i$层以及以上的概率就是
$$
\frac{1}{2^{i+1}-1}
$$
证明这个需要做一些准备工作

我们假设一开始节点都是红色的，在算法的bubble down阶段所走过的路径上节点的颜色改为蓝色，然后将bubble up阶段走过的路径节点的颜色为绿色

可以发现如果给定建好的堆标号和颜色，那么可以唯一确定这个输入的排列

那么证明就是如果插入堆的那个数停留在$i,i+1$之间，假设这些节点是$y,z$，有$y$是蓝色，并且$x<z,y<z$

那么可以通过归纳，首先证明到达根的概率是$\frac{1}{2^{k+1}-1}$，然后由于根是最大的，那么下面的应该是第二，三大的那么就是$\frac{1}{2^k-1}$的概率，依次归纳下去就证明结束



根据这个定理可以推出某一个插入节点深度为i的概率
$$
(\prod\limits_{j=i+1}^k 1-\frac{1}{2^{j+1}-1})\frac{1}{2^{i+1}-1}\\
=\frac{2^{k-i}}{2^{k+1}-1}
$$
然后插入整个排列期望比较次数
$$
1+\sum\limits_{i=0}^{k-1}\frac{i2^{k-i}}{2^{k+1}-1}+\frac{k-1}{2^{k+1}-1}
$$
将次数分离开来，然后剩下的是一个类似$\sum i2^{k-i}$的东西

结果就是$2-\frac{k+2}{2^{k+1}-1}$

这个渐进是$1.649$的样子

# 定理2

一个节点有到根的祖先序列$(c_i,...,c_k)$，的概率是$\prod\limits_{j=i}^k p_j$

$p_j$的定义如下

![BUILD](D:\Blog\image\BUILD.PNG)

证明就需要分1情况大讨论了

事实上我们只需要证明在叶子节点这个定理成立，那么可以通过归纳扩展到非叶子节点

证明：

考虑将祖先序列分段

第一段任意序列，并且分界点不是绿色，第二段都是绿色节点，然后后面跟着一个红色节点，然后最后一段是蓝色

相当于就是一次bubble up之后，后面节点没有越过其的，bubble down路径上节点的颜色的序列

考虑建立递归式

我们假设$P(c)$表示$\{c_0,...,c_l\}$是祖先在深度为l堆中的概率

可以通过定理1，和上面的推导得到
$$
P(S(j,c))=\frac{2^{k-j}}{(2^{k+1}-1)2^{j-l}}P(C)
$$
然后就可以发现$S(j,c)$​只能被三种序列递推过来，分情况讨论一下

# 定理三

红色节点在bubble down阶段在深度$i$的地方概率为
$$
\frac{2^{k-i-1}}{2^k-1}
$$
证明：

需要通过上面的定理证明

如果一个红色节点所有祖先都是蓝色的概率为$\frac{2^{k-i-1}}{2^k-1}$

然后由于有$2^{k-i}$个节点在i深度，根据定理2，在i深度的概率为$\frac{1}{2^{k-i}}$

那么最终概率还是$\frac{2^{k-i-1}}{2^k-1}$



那么可以得出这个算法在整个过程中进行比较的总次数为
$$
\sum\limits_{i=0}^{k-1}\frac{(k-i)2^{k-i-1}}{2^k-1}=k-1+\frac{k}{2^k-1}
$$
应该可以通过无穷递降法，确定当$k\rightarrow \infin$，是这个式子趋向于1.881373 