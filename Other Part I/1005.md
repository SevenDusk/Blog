# 1005模拟

# A.树

## 题目大意

![20211008T](D:\Blog\image\20211008T.PNG)

## 算法讨论

如果记$T_n$表示$n$次变化后得到的树

那么$T_n$的结构应该是根节点下面挂了$n-1$个子树，分别为$T_{n-1},T_{n-2},T_{n-3}...$

考虑记$F_n(x)$表示为$n$次变化后的答案的生成函数，$G_n(x)$表示$n$次变化后$T_n$中各个深度节点数的生成函数
$$
G_n=G_{n-1}+xG_{n-1}=(1+x)G_{n-1}=(1+x)^n
$$

$$
\begin{align}
F_n&=\sum\limits_{i<n}F_i+\sum\limits_{i<n}xG_i+\sum\limits_{i<j}x^2G_iG_j
\\&=\sum\limits_{i<n}F_i-1+(1+x)^n+\frac{x^2}{2}((\sum\limits_{i<n}G_i)^2-\sum\limits_{i<n}G_i^2)
\\&=\sum\limits_{i<n}F_i+(1+x)^n-1+\frac{x^2}{2}(\frac{(1+x)^{2n}-2(1+x)^n+1}{x^2}-\frac{(1+x)^{2n}-1}{x^2+2x})
\\&=\sum\limits_{i<n}F_i+\frac{(x+1)^{2n}-1}{x+2}
\\&=F_{n-1}+\sum\limits_{i<n-1}F_i+\frac{(x+1)^{2n}-1}{x+2}
\\&=2F_{n-1}+\frac{(x+1)^{2n}-1}{x+2}-\frac{(x+1)^{2n-2}-1}{x+2}
\\&=2F_{n-1}+x(x+1)^{2n-2}
\end{align}
$$

像这种递归式尽量拆成只能前面一项有关的

第一部分贡献是$n-1$子树内的贡献，第二部分是从根节点到各个子树内的贡献，第三部分是子树两两之间的贡献

然后考虑后面部分的贡献
$$
\begin{align}
F_n&=\sum\limits_{i=1}^{n-1}2^{n-i}x(x+1)^{2i-2}
\\&=\frac{2^nx-x(x+1)^{2n}}{-x^2-2x+1}
\end{align}
$$
可以将下面的分母拆成
$$
\frac{a}{1-Ax}+\frac{b}{1-Bx}
$$
的性质，那么求第$x^i$前的系数就可以通过扩域快速幂实现了

时间复杂度$O(d)$

# B.圈

## 题目大意

现在有$n$个人站成一圈，第$i$个人有$a_i$个球，每一个人可以将自己手中的球任意个数交给下一个人，记操作之后得到的序列$b_i$，求对于所有合法的序列$b$，$\prod b_i$的和
$$
n\leq 10^6
$$

## 算法讨论

首先考虑一个人留下了$c_i$个球，给下一个人了$d_i$个球，那么$b_i=c_i+d_{i-1}$

那么$\prod b_i=\prod (c_i+d_{i-1})$考虑将这个式子展开，得到$2^n$个项，如果我们知道对应一个项来说在所有情况的和是什么，那么可以方便进行$O(n)$DP

考虑连乘式中所有的独立变量，注意$c_i$与$d_i$不是互相独立的

- 如果$c_i,d_i$都出现在这个连乘式里面，那么其贡献就是$\sum\limits_{j=0}^{a_i}j\times(a_i-j)$
- 如果只出现了其中一个，那么贡献就是$\sum\limits_{j=0}^{a_i} j$
- 如果都没有出现，那么贡献就是$a_i+1$

对于一个连乘式，其贡献就是所有$n$个变量的贡献乘积，**由于是乘积的形式，那么我们就可以进行DP了**

由于这是一个环型结构，那么我们需要从某一个地方断环成链，并且在DP过程中记录第一个位置选择的是$c_i$还是$d_{i-1}$，以此确定最后一个位置的选择是否合法

考虑枚举第一个位置是选择了哪个，设$dp(i,0/1)$表示考虑到第$i$个位置，如果0表示当前选了$c_i$，否则就表示选了$d_{i-1}$，那么可以枚举上一次是选了哪个，那么就可以确定$c_{i-1},d_{i-1}$哪些被选入当前的连乘式中，那么就可以将对应的贡献算到转移中去

然后需要考虑最后一个位置的选择情况，然后将$c_n,d_n$的贡献算到总的贡献中去

然后这样求出的是所有方案的和，题目中求的是对于所有合法的$b$的和，那么其中就需要减去一部分多算的，**注意到如果操作的方案中不存在$d_i=0$的化，那么不断将所有的$d_i$减1，直到出现0为止，会发现和之前得到的$b$是相同的，并且对于存在$d_i=0$两个不同的方案来说是唯一对应着一个$b$的**

那么上面的贡献就需要抛去$d_i=0$的情况，再做一遍同样的DP，然后将第一次DP的结果减去第二次DP的结果就是答案

时间复杂度$O(n)$

# C.火

## 题目大意

有一个无限大的网格图，在第 0 秒的时候，有 $𝑛$ 个格子会着火，每隔一秒，一个着火的格子会导致和它八连通的未着火的格子着火。定义一个着火格子的权值为它最早着火的时间（秒），求 $𝑡$ 秒后所有着火格子的权值和。
答案对 998244353 取模。
$$
n\leq 50
$$

## 算法讨论

首先一个点到一个初始着火点的距离是定义为切比雪夫距离

首先需要对答案进行转化，假设$(x,y)$点第一次着火的时间为$k_{x,y}$，时刻为$i$的时候所有着火格子数量为$s_i$
$$
\sum\limits_{x,y} k_{x,y}=(t+1)s_t-\sum\limits_{i=1}^t s_i
$$
那么我们只需要求出所有$t$个时刻，$n$个矩形的面积并之和即可

当一个时间段不存在新的矩形相交事件发生的时候，其面积并关于$t$的函数关系是二次函数关系，这是由于其边界是关于函数成线性关系（每一次先外扩展一圈，在保留原来轮廓数量同时，会加入外凸点数，当不存在新的相交时间发生前，外凸点数是不变的常数）

那么对应一个较长的时间段，我们可以通过求出三个时刻的答案，插值出这个二次函数，然后进行区间求和即可，至于出现新的矩形相交可以$O(n^2)$枚举得到

假设当前枚举到的点为$(x_i,y_i),(x_j,y_j)$，那么相交时间为其切比雪夫距离除以2上取整

至于矩形面积并，可以通过扫描线离散化，做到$O(n^2)$

总时间复杂度$O(n^4)$

据说分成的时间段数量是$O(n)$级别的

# D.排列

## 题目大意

对于长度为$4$两两不同的序列$t_1,t_2,t_3,t_4$，定义其权值为

- 1:$t_1<t_3<t_2<t_4$
- -1:$t_1<t_4<t_3<t_2$或者$t_1<t_2<t_4<t_3$
- 其他情况为0

给定长度为$n$的排列，求出其所有长度为4的子序列权值的和
$$
n\leq 2*10^5
$$

## 算法讨论

首先对于这三种排列

1 3 2 4

1 4 3 2

1 2 4 3

直接做四个数的偏序关系，是很难做的，需要转化为三个数乃至更少的数

首先第一位能够产生贡献的排列都为1，那么先省去不看

对于后三位的所有排列，类似三维偏序转二维偏序的关系，我们考虑计算所有的顺序对数量，那么一个排列贡献的次数就是其顺序对贡献次数和

| 排列  | 实际计算得出贡献 | 要求贡献 | 相差 |
| ----- | ---------------- | -------- | ---- |
| 1 2 3 | 3                | 0        | -3   |
| 1 3 2 | 2                | -1       | -3   |
| 2 1 3 | 2                | +1       | -1   |
| 2 3 1 | 1                | 0        | -1   |
| 3 1 2 | 1                | 0        | -1   |
| 3 2 1 | 0                | -1       | -1   |

那么需要将实际计算贡献调整为要求贡献

考虑先将所有的排列贡献减1，相当于求出所有1 ? ? ?的排列数量

然后在将前两个的贡献-2，相当于求出所有1 2 ? ? 的排列数量$\times 2$

考虑具体实现，其中我们要确定1的位置，然后在后面选出两个比1位置上数大的数并且形成了顺序对

那么我们利用树状数组维护出每一个位置$i$后面比$a_i$大的数个数$b_i$，那么第一个贡献就是求出$\sum\limits_{j>i}[a_j>a_i]b_j$

求出1 ? ? ?的排列数量就是$\sum\limits_{i=1}^n \binom{b_i}{3}$

求出1 2 ? ?的排列数量就是，需要枚举2所在位置，那么需要求出在这个位置之前有多少数小于$a_i$，然后与$\binom{b_i}{2}$相乘即可

所有操作都可以用树状数组实现

时间复杂度$O(n\log n)$